# 07. GitHub Actions ã«ã‚ˆã‚‹ Terraform ã‚’ç”¨ã„ãŸ CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€GitHub Actions ã‚’åˆ©ç”¨ã—ã¦ã€Terraform ã«ã‚ˆã‚‹ AWS ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®æ§‹ç¯‰ã¨ã€Spring Boot ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã® AWS Elastic Beanstalk ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è‡ªå‹•åŒ–ã™ã‚‹æ‰‹é †ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

---

## ğŸš€ æ§‹æˆæ¦‚è¦

| é …ç›®               | å†…å®¹                                        |
|--------------------|---------------------------------------------|
| ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†       | Terraform                                   |
| CI/CD ãƒ„ãƒ¼ãƒ«       | GitHub Actions                              |
| ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡       | Spring Boot ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆJAR ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ |
| ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ         | AWS Elastic Beanstalkï¼ˆJava SE ç’°å¢ƒï¼‰       |
| çŠ¶æ…‹ç®¡ç†           | Terraform Backendï¼ˆS3 + DynamoDBï¼‰          |

---

## ğŸ›  å‰ææ¡ä»¶

- **AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ï¼šå¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã§ãã‚‹æ¨©é™ã‚’æŒã¤ã“ã¨ã€‚
- **GitHub ãƒªãƒã‚¸ãƒˆãƒª**ï¼šSpring Boot ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã€‚
- **Terraform ç’°å¢ƒ**ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ãƒªãƒ¢ãƒ¼ãƒˆã§ Terraform ãŒå®Ÿè¡Œå¯èƒ½ã§ã‚ã‚‹ã“ã¨ã€‚

---

## ğŸ”‘ AWS èªè¨¼æƒ…å ±ã®è¨­å®š

GitHub Actions ã‹ã‚‰ AWS ã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®æ‰‹é †ã§èªè¨¼æƒ…å ±ã‚’è¨­å®šã—ã¾ã™ã€‚

1. **IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ**ï¼š
   - AWS ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã€å¿…è¦ãªæ¨©é™ï¼ˆä¾‹ï¼šElastic Beanstalkã€S3ã€RDS ãªã©ï¼‰ã‚’æŒã¤ IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚
   - ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ ID ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’å–å¾—ã—ã¾ã™ã€‚

2. **GitHub Secrets ã®è¨­å®š**ï¼š
   - GitHub ãƒªãƒã‚¸ãƒˆãƒªã®è¨­å®šã‹ã‚‰ã€ã€ŒSettingsã€â†’ã€ŒSecrets and variablesã€â†’ã€ŒActionsã€ã«ç§»å‹•ã—ã¾ã™ã€‚
   - ä»¥ä¸‹ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚
     - `AWS_ACCESS_KEY_ID`ï¼šIAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ ID
     - `AWS_SECRET_ACCESS_KEY`ï¼šIAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼

---

## ğŸ“ GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä½œæˆ

ãƒªãƒã‚¸ãƒˆãƒªå†…ã« `.github/workflows/deploy.yml` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```yaml
name: Deploy to AWS

on:
  push:
    branches:
      - main

jobs:
  terraform:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest

    steps:
      - name: 'ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
        uses: actions/checkout@v3

      - name: 'Terraform ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.0

      - name: 'AWS èªè¨¼æƒ…å ±ã®è¨­å®š'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: 'Terraform åˆæœŸåŒ–'
        run: terraform init

      - name: 'Terraform ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯'
        run: terraform fmt -check

      - name: 'Terraform æ¤œè¨¼'
        run: terraform validate

      - name: 'Terraform ãƒ—ãƒ©ãƒ³'
        run: terraform plan

      - name: 'Terraform é©ç”¨'
        run: terraform apply -auto-approve

  deploy:
    name: 'Deploy to Elastic Beanstalk'
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - name: 'ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
        uses: actions/checkout@v3

      - name: 'AWS èªè¨¼æƒ…å ±ã®è¨­å®š'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: 'Java ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: 'Maven ãƒ“ãƒ«ãƒ‰'
        run: mvn clean package

      - name: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä½œæˆ'
        run: |
          mkdir deploy
          cp target/*.jar deploy/application.jar
          echo "web: java -jar application.jar" > deploy/Procfile
          cd deploy
          zip -r deploy.zip .

      - name: 'Elastic Beanstalk ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤'
        run: |
          eb init -p java-11 springboot-book-api --region ap-northeast-1
          eb deploy
```

---

## ğŸ”„ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å‹•ä½œ

1. **Terraform ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰**ï¼š
   - Terraform ã‚’ä½¿ç”¨ã—ã¦ã€Elastic Beanstalk ç’°å¢ƒã€RDSï¼ˆAuroraï¼‰ã€S3 ãƒã‚±ãƒƒãƒˆãªã©ã® AWS ãƒªã‚½ãƒ¼ã‚¹ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

2. **Spring Boot ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤**ï¼š
   - Maven ã‚’ä½¿ç”¨ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€ç”Ÿæˆã•ã‚ŒãŸ JAR ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Elastic Beanstalk ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

---

## ğŸ§© ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

- **èªè¨¼ã‚¨ãƒ©ãƒ¼**ï¼š
  - AWS èªè¨¼æƒ…å ±ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

- **Terraform ã®é©ç”¨ã‚¨ãƒ©ãƒ¼**ï¼š
  - Terraform ã®æ§‹æ–‡ã‚„è¨­å®šãŒæ­£ã—ã„ã‹ã€ã¾ãŸå¿…è¦ãª AWS ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

- **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼**ï¼š
  - Elastic Beanstalk ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã€ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚

---

## ğŸ”— å‚è€ƒãƒªãƒ³ã‚¯

- [Terraform ã¨ GitHub Actions ã‚’ä½¿ç”¨ã—ãŸ CI/CD ã®è‡ªå‹•åŒ–](https://developer.hashicorp.com/terraform/tutorials/automation/github-actions)
- [GitHub Actions ã§ã® AWS èªè¨¼æƒ…å ±ã®è¨­å®š](https://docs.aws.amazon.com/ja_jp/elasticbeanstalk/latest/dg/eb-cli3-install.html)

